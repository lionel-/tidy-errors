---
title: "Leave no error unkempt"
author: "Lionel Henry"
format:
  revealjs:
    theme: [beige, style.scss]
    center: true
    auto-stretch: false
knitr:
  opts_chunk:
    collapse: true
    comment: "#>"
    echo: TRUE
---

```{r include=FALSE}
library(tidyverse)
```


## Why take time for errors

:::: columns
::: {.column width="60%"}
- Main way users interact with your software
- Often an afterthought
:::

::: {.column width="40%"}
![](error-window.png){}
:::

::::

::: notes
Package developers have to deal with lots of chores:
- Unit tests
- Documentation
- Comments
- Input checking

Error reporting isn't a priority but is important nonetheless.
:::

---

:::: columns
::: {.column width="55%"}
#### Principles of clarity

1. Consistency
1. Transparency
1. Relevance
1. Exhaustiveness
1. Conciseness
:::

::: {.column width="45%"}
#### Tools

- Format with cli
- Follow the style guide
- Use error bullets
- Pass error calls
- Use chained errors
:::
::::

::: {.notes}
Consistency: Repetition is good. Recognisability. Style guide.
Transparency: Reveal inputs
Relevance: Where did the error fail. Fail early.
Exhaustiveness: Context matters.
Conciseness: Don't overwhelm.
:::


# Follow the style guide

## Follow the style guide

::: {.callout-note appearance="simple" icon=false}
::: my-smaller
**Principle** of consistency
:::
:::

- <https://style.tidyverse.org>

- Use "must" and "can't" phrasings

  - "Must" when you know what is a valid input
  - "Can't" when you know what an invalid input

- Guiding error style is hard---still a WIP


# Format with cli

## Format with cli

- Most of the features presented here require `cli::cli_abort()`

- Like `base::stop()` but with many additional features

- To get help:

  - Read the cli documentation at <https://cli.r-lib.org/>
  - Consult `?rlang::abort`


## glue interpolation

::: {.callout-note appearance="simple" icon=false}
::: my-smaller
**Principle** of transparency (show values)
:::
:::

cli embeds glue interpolation

```{r error=TRUE}
action <- "paint"
what <- "canvas"
how <- "in green"

cli::cli_abort("Can't {action} {what} {how}.")
```

::: notes
Interpolating encourages us to create dynamic rather than static messages, which in turn helps us create transparent rather than opaque error messages.
:::

---

## cli style classes

::: {.callout-note appearance="simple" icon=false}
::: my-smaller
**Principle** of consistency
:::
:::


It supports style classes (quotes and colours)

```{r error=TRUE}
cli::cli_abort("{.arg x} can't be supplied to {.code foo()}.")
```

---

Styles and interpolation can be combined

```{r error=TRUE}
arg <- "x"
call <- "foo()"

cli::cli_abort("{.arg {arg}} can't be supplied to {.code {call}}.")
```

---

Check out all the advanced cli features, e.g. pluralisation

```{r error=TRUE}
n_files <- 1

cli::cli_abort("Can't supply {n_files} file{?s}.")
```

\

```{r error=TRUE}
n_files <- 2

cli::cli_abort("Can't supply {n_files} file{?s}.")
```


# Use error bullets

## Use error bullets

:::: columns

::: {.column width="60%"}
Be *concise*:

- Avoid paragraphs of text
- Be straight to the point

But be *exhaustive*:

- Include contextual information
- Point to external resources
:::

::: {.column width="40%"}
::: {.callout-note appearance="simple" icon=false}
::: my-smaller
**Principles**

- Concision
- Exhaustiveness
:::
:::
:::

::::

---

Contextual information:

```{r, error=TRUE}
starwars[, 1:25]
```

\

Recommendation and external resource: \

```{r include=FALSE}
rlang::reset_message_verbosity("strict_lookup_var")
```
```{r message = TRUE}
var <- "height"
invisible(starwars |> select(var))
```

---

Pass a named vector as error message to create bullets

```{r error=TRUE}
cli::cli_abort(c(
  "My error message.",
  "*" = "Bullet",
  "i" = "Info bullet",
  "x" = "Cross bullet",
  "v" = "Check bullet"
))
```

---

Create named bullets programmatically with `set_names()`

```{r include=FALSE}
set.seed(5)
```

```{r error=TRUE}
# Variable length character vector
bullets <- letters[seq_len(sample(3:5))]

# Set their bullet names
bullets <- set_names(bullets, "*")

cli::cli_abort(c("My error message.", bullets))
```


# Pass error calls

## Pass error calls

## Transparency

- Which function failed? For which argument?
- What did you expect, what did you get?
- Reveal input type and any other relevant aspect

::: {.callout-note appearance="simple" icon=false}
::: my-smaller
- See `obj_type_friendly()` and `stop_input_type()` in `compat-obj-type.R`\
  <https://github.com/r-lib/rlang/blob/main/R/compat-obj-type.R>

- See examples in `types-check.R`\
  <https://github.com/r-lib/rlang/blob/main/R/types-check.R>
:::
:::

---

From `types-check.R`\
<https://github.com/r-lib/rlang/blob/main/R/types-check.R>

```{r include=FALSE}
library(rlang)
stop_input_type <- rlang:::stop_input_type
obj_type_friendly <- rlang:::obj_type_friendly
```

```{r}
check_string <- function(x,
                         ...,
                         what = "a single string",
                         arg = caller_arg(x),
                         call = caller_env()) {
  if (!is_string(x)) {
    stop_input_type(x, what, ..., arg = arg, call = call)
  }
}

my_function <- function(my_arg) {
  check_string(my_arg)
}
```

\

```{r error=TRUE}
my_function(1)
```


## Relevance

In `check_string()` we passed `arg` and `call` arguments:

```{r error=TRUE}
my_function(my_arg = 1)
```

```{r include=FALSE}
check_string <- function(x,
                         ...,
                         what = "a single string") {
  if (!is_string(x)) {
    stop_input_type(x, what, ...)
  }
}
```

\

Here is what it would look otherwise:

```{r error=TRUE}
my_function(my_arg = 1)
```

---

```{r}
my_check_string <- function(x,
                            arg = caller_arg(x),
                            call = caller_env()) {
  if (!is_string(x)) {
    expected <- obj_type_friendly(x)
    cli::cli_abort(
      "{.arg {arg}} must be a single string, not {}",
      arg = arg,
      call = call
    )
  }
}
```

---

`my_function()`

- Failing early (esp. important with lazy evaluation)
- Pass call when failing on behalf of
